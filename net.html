<html>
<head>
<title>Network Configuration</title>
<link rel="stylesheet" href="res/jquery-ui-1.11.4.custom/jquery-ui.min.css" />
<script src="res/jquery-2.2.4.min.js"></script>
<script src="res/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
<style>
</style>
<script>

</script>
</head>

<body>
<h1 style="float: left;">Network Configuration</h1>

<div style="float: right;" id="buttons">
<input id="reset" type="button" name="reset" value="Reset"></input>
<input id="update" type="button" name="update" value="Update"></input>
</div>

<div style="clear: both;" id="interfaces">
<ul></ul>
</div>

<script>
$.ajax("current_settings.php", {
	context:	this,
	cache:		false,
	dataType:	'json',
	ifModified:	true,
	headers:	{}
}).done(function (data, status, XHR) {
	var config = data.config;
	delete data.config;
	for (var iface in data) {
		var $li = $('<li><a href="#interface-' + iface + '">' + iface + '</a></li>');
		$('#interfaces ul').append($li);
		var $ifconfig = $('<div class="interface"></div>');
		$('#interfaces').append($ifconfig);
		$ifconfig.attr('id', 'interface-' + iface);
		$ifconfig_table = $('<table border=0>');
		function add_option(config, data, $table, option, title, iface, alias) {
			var option_id = 'config-' + iface + '-' + (alias) ? alias + '-' + option : '-' + option;
			var config_value = (alias) ? config[alias].inet[option] : config[iface][option];
			var checked = (config_value) ? " checked" : "";
			var disabled = (config_value) ? "" : " disabled";
			var value = (config_value) ? config_value : (alias) ? data[iface][alias].inet[option] : data[iface][option];
			if (value === null || value == undefined) {
				value = "";
			}
			var $tr = $('<tr>');
			$tr.append('<th><label for="'+option_id+'-set">'+title+'</label><input id="'+option_id+'-set" type="checkbox" name="hwaddress_set"'+checked+'></input></th>');
			$tr.append('<td><input type="input" id="'+option_id+'" name="'+option+'" value="'+value+'"'+disabled+'></input></td>');
			$tr.find('input[type=checkbox]').button();
			$table.append($tr);
		}
		add_option(config, data, $ifconfig_table, 'hwaddress', 'MAC Address', iface);
		add_option(config, data, $ifconfig_table, 'mtu', 'MTU', iface);
		$ifconfig.append($ifconfig_table);
		$ifconfig.append('<br />');

		$ifconfig_aliases = $('<div class="config-interface"></div>');
		$ifconfig.append($ifconfig_aliases);
		for (var alias in data[iface]) {
			var inet = data[iface][alias]['inet'];
			if (!inet) {
				continue;
			}
			var $alconfig = $('<div class="alias"></div>');
			$alconfig.attr('id', 'interface-' + iface + '-' + alias);
			var $alias_table = $('<table border="0"></table>');
			//add_option(config, data, $alias_table, 'hostname', 'Hostname', iface, alias);
			add_option(config, data, $alias_table, 'address', 'Address', iface, alias);
			add_option(config, data, $alias_table, 'netmask', 'Netmask', iface, alias);
			//add_option(config, data, $alias_table, 'pointopoint', 'Point to Point', iface, alias);
			add_option(config, data, $alias_table, 'gateway', 'Gateway', iface, alias);
			add_option(config, data, $alias_table, 'metric', 'Metric', iface, alias);
			//add_option(config, data, $alias_table, 'nameserver', 'Nameserver', iface, alias);
			$alconfig.append($alias_table);
			$ifconfig_aliases.append('<h3>' + alias + '</h3>');
			$ifconfig_aliases.append($alconfig);
		}
		$ifconfig_aliases.accordion();
/*
			$alconfig.html('\
	<div class="config-alias">\
		<span class="title">Configuration Method:</span>\
		<span class="form">\
			<select class="configure-method" name="method">\
				<option value="dhcp">DHCP</option>\
				<option value="static">Static</option>\
			</select>\
		</span>\
		<table border=0>\
		<!-- <tr><th>Scope:</th><td><select name="scope"><option>global</option><option>link</option><option>host</option></select></td></tr> -->\
		</table>\
	</div>');
	$alconfig.find(".configure-method").selectmenu({
		width:	128,
	});
*/
	}
	$("#interfaces").tabs();
}).fail(function (XHR, status, error) {
	alert("Failed to get configuration information!");
});
$("input:button").button();
$("#reset").click(function (event) {
	location.reload();
});
$("#update").click(function (event) {
	var config = {};
	$(".interface").each(function (index, el) {
		var iface = $(this).attr('id').substring(10);
		config[iface] = {
			mtu: $(this).find('input[name="mtu"]').first().val()
		};
		$(this).find('.alias').each(function (index, el) {
			var alias = $(this).attr('id').substring(iface.length + 11);
			if (alias != iface) {
				config[alias] = {};
			}
			config[alias].inet = {};
			$(this).find('input[type=text]').each(function (index, el) {
				if ($(this).prop('disabled')) {
					return;
				}
				var option = $(this).prop('name');
				var value = $(this).val();
				if (value.trim() == "" || value == "undefined") {
					return;
				}
				if (config[alias].inet[option] != undefined) {
					if ($.isArray(config[alias].inet[option])) {
						config[alias].inet[option].push(value);
					} else {
						config[alias].inet[option] = [ config[alias].inet[option], value ];
					}
				} else {
					config[alias].inet[option] = value;
				}
			});
		});
	});
	alert(JSON.stringify(config));
});
</script>
</body>
</html>
