<html>
<head>
<title>Network Configuration</title>
<link rel="stylesheet" href="res/jquery-ui-1.11.4.custom/jquery-ui.min.css" />
<script src="res/jquery-2.2.4.min.js"></script>
<script src="res/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
<style>
label {
	width: 100%;
}
.ui-selectmenu-button {
	background-color:	#007FFF !important;
	border-color:		#003ECF !important;
	color:			#FFF !important;
}
.ui_changed {
	background-color:	#7FCF7F !important;
	border-color:		#7F7F7F !important;
	color:			#000 !important;
}
.ui_changed.ui-state-active, .ui_changed.ui-selectmenu-button{
	background-color:	#007F00 !important;
	border-color:		#003E00 !important;
	color:			#FFF !important;
}
.ui_error {
	background-color:	#FFCFCF !important;
	border-color:		#7F7F7F !important;
	color:			#000 !important;
}
.ui_error.ui-state-active, .ui_error.ui-selectmenu-button {
	background-color:	#7F0000 !important;
	border-color:		#3E0000 !important;
	color:			#FFF !important;
}
</style>
</head>

<body>
<h1 style="float: left;">Network Configuration</h1>

<div style="float: right;" id="buttons">
<input id="reset" type="button" name="reset" value="Reset"></input>
<input id="update" type="button" name="update" value="Update"></input>
</div>

<div style="clear: both;" id="interfaces">
<ul></ul>
</div>

<script>
$("#update").prop('disabled', true);
$("input:button").button();
$("#reset").click(function (event) {
	location.reload();
});
$("#update").click(function (event) {
	var config = {};
	$(".interface").each(function (index, el) {
		var iface = $(this).attr('id').substring(10);
		config[iface] = {
			mtu: $(this).find('input[name="mtu"]').first().val()
		};
		$(this).find('.alias').each(function (index, el) {
			var alias = $(this).attr('id').substring(iface.length + 11);
			if (alias != iface) {
				config[alias] = {};
			}
			config[alias].inet = {};
			$(this).find('input[type=text]').each(function (index, el) {
				if ($(this).prop('disabled')) {
					return;
				}
				var option = $(this).prop('name');
				var value = $(this).val();
				if (value.trim() == "" || value == "undefined") {
					return;
				}
				if (config[alias].inet[option] != undefined) {
					if ($.isArray(config[alias].inet[option])) {
						config[alias].inet[option].push(value);
					} else {
						config[alias].inet[option] = [ config[alias].inet[option], value ];
					}
				} else {
					config[alias].inet[option] = value;
				}
			});
		});
	});
	alert(JSON.stringify(config));
});
$.ajax("current_settings.php", {
	context:	this,
	cache:		false,
	dataType:	'json',
	ifModified:	true,
	headers:	{}
}).done(function (data, status, XHR) {
	var config = data.config;
	delete data.config;
	for (var iface in data) {
		var $li = $('<li><a href="#interface-' + iface + '">' + iface + '</a></li>');
		$('#interfaces ul').append($li);
		var $ifconfig = $('<div class="interface"></div>');
		$('#interfaces').append($ifconfig);
		$ifconfig.attr('id', 'interface-' + iface);
		$ifconfig_table = $('<table border=0>');
		function add_option(config, data, $table, option, title, iface, alias) {
			var option_id = 'config-' + iface + '-' + (alias ? alias + '-' + option : option);
			var config_value = (alias) ? config[alias].protocol.inet[option] : config[iface][option];
			var checked = (config_value) ? " checked" : "";
			var disabled = (config_value) ? "" : " disabled";
			var value = (config_value) ? config_value : (alias) ? data[iface][alias].inet[option] : data[iface][option];
			if (value === null || value == undefined) {
				value = "";
			}
			var $tr = $('<tr>');
			$tr.append('<th><label for="'+option_id+'-set">'+title+'</label><input id="'+option_id+'-set" type="checkbox" name="'+option+'"'+checked+'></input></th>');
			$tr.append('<td><input type="text" id="'+option_id+'" name="'+option+'" value="'+value+'"'+disabled+'></input></td>');
			$tr.find('input[type=text]').data('value_orig', config_value).data('$label', $tr.find('label')).bind('propertychange change keyup click keyup input paste', function(ev) {
				var value = $(this).val();
				var value_orig = $(this).data('value_orig');
				if (value != value_orig) {
					$(this).data('$label').addClass("ui_changed");
				} else {
					$(this).data('$label').removeClass("ui_changed");
				}
			});
			$tr.find('input[type=checkbox]').button().click(function(ev) {
				var set = $(this).prop('checked');
				var $input = $(this).parent().parent().find('input[type=text]');
				var value = $input.val();
				var value_orig = $input.data('value_orig');

				if (!set && value_orig == undefined || set && value_orig == value) {
					$input.data('$label').removeClass("ui_changed");
				} else {
					$input.data('$label').addClass("ui_changed");
				}
				$input.attr('disabled', !set);
			});
			$table.append($tr);
		}
		add_option(config, data, $ifconfig_table, 'hwaddress', 'MAC Address', iface);
		add_option(config, data, $ifconfig_table, 'mtu', 'MTU', iface);
		$ifconfig.append($ifconfig_table);
		$ifconfig.append('<br />');

		$ifconfig_aliases = $('<div class="config-interface"></div>');
		$ifconfig.append($ifconfig_aliases);
		for (var alias in data[iface]) {
			var inet = data[iface][alias].inet;
			if (!inet) {
				continue;
			}
			var inet_config = config[alias].protocol.inet;
			var $alconfig = $('<div class="alias"></div>');
			$alconfig.attr('id', 'interface-' + iface + '-' + alias);
			var $config_select = $('<select name="method"></select>');
			if (inet_config.method == "dhcp" || inet_config.method == "static") {
				$config_select.append('<option value="dhcp">DHCP</option>');
				$config_select.append('<option value="static">Static</option>');
			} else {
				$config_select.append('<option>'+inet_config.method+'</option>');
			}
			$config_select.val(inet_config.method);
			$alconfig.append($config_select);
			$config_select.selectmenu({
				width: 192
			});
			var $alias_table = $('<table border="0"></table>');
			//add_option(config, data, $alias_table, 'hostname', 'Hostname', iface, alias);
			add_option(config, data, $alias_table, 'address', 'Address', iface, alias);
			add_option(config, data, $alias_table, 'netmask', 'Netmask', iface, alias);
			//add_option(config, data, $alias_table, 'pointopoint', 'Point to Point', iface, alias);
			add_option(config, data, $alias_table, 'gateway', 'Gateway', iface, alias);
			//add_option(config, data, $alias_table, 'metric', 'Metric', iface, alias);
			//add_option(config, data, $alias_table, 'nameserver', 'Nameserver', iface, alias);
			$alconfig.append($alias_table);
			$ifconfig_aliases.append('<h3>' + alias + '</h3>');
			$ifconfig_aliases.append($alconfig);
		}
		$ifconfig_aliases.accordion();
/*
			$alconfig.html('\
	<div class="config-alias">\
		<span class="title">Configuration Method:</span>\
		<span class="form">\
			<select class="configure-method" name="method">\
				<option value="dhcp">DHCP</option>\
				<option value="static">Static</option>\
			</select>\
		</span>\
		<table border=0>\
		<!-- <tr><th>Scope:</th><td><select name="scope"><option>global</option><option>link</option><option>host</option></select></td></tr> -->\
		</table>\
	</div>');
	$alconfig.find(".configure-method").selectmenu({
		width:	128,
	});
*/
	}
	$("#interfaces").tabs();
	$('#update').button('enable');
}).fail(function (XHR, status, error) {
	alert("Failed to get configuration information!");
});
</script>
</body>
</html>
