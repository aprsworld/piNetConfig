<html>
<head>
<title>Network Configuration</title>
<link rel="stylesheet" href="res/jquery-ui-1.11.4.custom/jquery-ui.min.css" />
<script src="res/jquery-2.2.4.min.js"></script>
<script src="res/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
<script src="js/validate-ip4.js"></script>
<style>
label {
	width: 100%;
}
.ui-textfield {
	font:		inherit;
	color:		inherit;
	background:	none;
	background-color:	#FFF !important;
	text-align:	inherit;
	outline:	none;
	cursor:		text;
}
.ui-state-focus, .ui-state-focus > a {
	outline:		none !important;
}
.ui-selectmenu-button {
	background-color:	#007FFF !important;
	border-color:		#003ECF !important;
	color:			#FFF !important;
}
.ui_changed {
	background-color:	#7FCF7F !important;
	border-color:		#7F7F7F !important;
	color:			#000 !important;
}
.ui_changed.ui-state-active, .ui_changed.ui-selectmenu-button {
	background-color:	#007F00 !important;
	border-color:		#003E00 !important;
	color:			#FFF !important;
}
.ui_error {
	background-color:	#FFCFCF !important;
	border-color:		#7F7F7F !important;
	color:			#000 !important;
}
.ui_error.ui-state-active, .ui_error.ui-selectmenu-button {
	background-color:	#7F0000 !important;
	border-color:		#3E0000 !important;
	color:			#FFF !important;
}
</style>
</head>

<body>
<h1 style="float: left;">Network Configuration</h1>

<div style="float: right;" id="buttons">
<input id="reset" type="button" name="reset" value="Reset"></input>
<input id="update" type="button" name="update" value="Update"></input>
</div>

<div style="clear: both;" id="interfaces">
<ul></ul>
</div>

<script>
$("#update").prop('disabled', true);
$("input:button").button();
$("#reset").click(function (event) {
	location.reload();
});
$("#update").click(function (event) {
	var config = {};
	$(".interface").each(function (index, el) {
		var iface = $(this).attr('id').substring(10);
		config[iface] = {
			mtu: $(this).find('input[name="mtu"]').first().val()
		};
		$(this).find('.alias').each(function (index, el) {
			var alias = $(this).attr('id').substring(iface.length + 11);
			if (alias != iface) {
				config[alias] = {};
			}
			config[alias].inet = {};
			var method = $(this).find('.ui-selectmenu-button').children('.ui-selectmenu-text').text().toLowerCase();
			if(method != undefined){
				config[alias].inet["method"] = method;
			}
			$(this).find('input[type=text]').each(function (index, el) {
				if ($(this).prop('disabled')) {
					return;
				}
				var option = $(this).prop('name');
				var value = $(this).val();
				if (value.trim() == "" || value == "undefined") {
					return;
				}
				if (config[alias].inet[option] != undefined) {
					if ($.isArray(config[alias].inet[option])) {
						config[alias].inet[option].push(value);
					} else {
						config[alias].inet[option] = [ config[alias].inet[option], value ];
					}
				} else {
					config[alias].inet[option] = value;
				}
			});
		});
	});
	console.log(config);
	var finalConfig = JSON.stringify({"config": config});
	console.log(finalConfig);
	alert(finalConfig);
	$.ajax({
			url: "netconfig.php",
			type: 'post',
			dataType: 'JSON',
			contentType: 'application/json',
			data: finalConfig ,
			cache: false,
			success: function(data) {
				console.log(data);
			},
			error: function (error) {
				console.log("error");
			}
	});
});

function ui_changed($input) {
	var $label = $input.data('$label');
	if (!$label) {
		$label = $input.next();
	}
	var $checkbox = $input.data('$checkbox');
	if (!$checkbox) {
		$checkbox = $('<input type="checkbox" checked></input>');
	}
	var $iface = $input.data('$iface');
	var $iface_widget = $input.data('$iface_widget');
	var $alias = $input.data('$alias');
	var $alias_widget = $input.data('$alias_widget');
	var disabled = $checkbox.prop('disabled');
	var set = $checkbox.prop('checked');
	var value = $input.val();
	var value_orig = $input.data('value_orig');

	if ((!disabled && set) && $input.prop('disabled')) {
		$input.button('enable');
	} else if ((disabled || !set) && !$input.prop('disabled')) {
		$input.button('disable');
	}
	if (disabled || (!set && value_orig == undefined || set && value_orig == value)) {
		if (!$label.hasClass("ui_changed")) {
			return;
		}
		$label.removeClass("ui_changed");
		$label.removeClass("ui_error");
		if ($alias) {
			if ($alias.find(".ui_error").size() == 0) {
				$alias_widget.removeClass("ui_error");
			}
			if ($alias.find(".ui_changed").size() == 0) {
				$alias_widget.removeClass("ui_changed");
			}
		}
		if ($iface.find(".ui_error").size() == 0) {
			$iface_widget.removeClass("ui_error");
		}
		if ($iface.find(".ui_changed").size() == 0) {
			$iface_widget.removeClass("ui_changed");
		}

		return;
	}

	var type = $input.attr('name');
	if ($alias && (type == 'address' || type == 'netmask' || type == 'gateway')) {
		var error = false;

		if ((!set && type != 'gateway') || !ip4_validate_address(ip4_parse_address(value))) {
			error = true;
		} else {
			var $address = $alias.find('input[type="text"][name="address"]');
			var $netmask = $alias.find('input[type="text"][name="netmask"]');
			var $gateway = $alias.find('input[type="text"][name="gateway"]');
			var address = null;
			if ($address.data('$checkbox').prop('checked') && ($address != $input && !$address.data('$label').hasClass("ui_error"))) {
				address = $address.val();
			}
			var netmask = null;
			if ($netmask.data('$checkbox').prop('checked') && ($netmask != $input && !$netmask.data('$label').hasClass("ui_error"))) {
				netmask = $netmask.val();
			}
			var gateway = null;
			if ($gateway.data('$checkbox').prop('checked') && ($gateway != $input && !$gateway.data('$label').hasClass("ui_error"))) {
				gateway = $gateway.val();
			}
			if (address && netmask && !ip4_validate_network(address, netmask, gateway)) {
				error = true;
			}
		}

		if (error) {
			if (!$label.hasClass("ui_error")) {
				$label.addClass("ui_error");
				if ($alias) {
					$alias_widget.addClass("ui_error");
				}
				$iface_widget.addClass("ui_error");
			}
		} else {
			if ($label.hasClass("ui_error")) {
				$label.removeClass("ui_error");
				if ($alias && $alias.find(".ui_error").size() == 0) {
					$alias_widget.removeClass("ui_error").removeClass("ui_error");
				}
				if ($iface.find(".ui_error").size() == 0) {
					$iface_widget.removeClass("ui_error");
				}
			}
		}
	}

	if ($label.hasClass("ui_changed")) {
		return;
	}
	$label.addClass("ui_changed");
	if ($alias) {
		$alias_widget.addClass("ui_changed");
	}
	$iface_widget.addClass("ui_changed");
}
/* config = config object from json, data = current settings from json, $table is the html element that holds everything,
// option = address, netmask, etc. , title = human readable title for option, iface = interface we are workign with
   alias = ex: eth0:0 */
function add_option(config, data, $table, option, title, iface, alias) {
	var option_id = 'config-' + iface + '-' + (alias ? alias + '-' + option : option);
	var available = true;
	if (alias && config[alias] && config[alias].protocol && config[alias].protocol.inet && config[alias].protocol.inet.method != 'static')  {
		available = false;
	}
	var config_value = null;
	if (alias && config[alias] && config[alias].protocol && config[alias].protocol.inet) {
		config_value = config[alias].protocol.inet[option];
	} else if (config[iface]) {
		config_value = config[iface][option];
	}
	var checked = (config_value) ? " checked" : "";
	var disabled = (config_value) ? "" : " disabled";
	var value = (config_value) ? config_value : (alias) ? data[iface][alias].inet[option] : data[iface][option];
	if (value === null || value == undefined) {
		value = "";
	}

	var $tr = $('<tr>');
	var $label = $('<label for="'+option_id+'-set">'+title+'</label>');
	// hidden checkbox that determines whether or not the input is shown
	var $checkbox = $('<input id="'+option_id+'-set" type="checkbox" name="'+option+'"'+checked+'></input>');
	$checkbox.prop('disabled', !available);
	var $th = $('<th></th>').append($label).append($checkbox);
	$tr.append($th);
	var $input = $('<input type="text" id="'+option_id+'" name="'+option+'" value="'+value+'"'+disabled+'></input>');
	var $td = $('<td></td>').append($input);
	$tr.append($td);

	$checkbox.data('$input', $input);
	$input.data('value_orig', config_value);
	$input.data('$label', $label);
	$input.data('$checkbox', $checkbox);
	$input.button().addClass('ui-textfield').off('mouseenter').off('mousedown').off('keydown').bind('propertychange change keyup click keyup input paste', function(ev) {
		ui_changed($(this));
	});
	$checkbox.button().bind('click change keyup propertychange input', function(ev) {
		ui_changed($(this).data('$input'));
	});
	$table.append($tr);
}


$.ajax("netconfig.php", {
	context:	this,
	cache:		false,
	dataType:	'json',
	ifModified:	true,
	headers:	{}
}).done(function (data, status, XHR) {
	var config = data.config;
	delete data.config;
	for (var iface in data) {
		// Create what will become the tabs for each interface at the top of the screen
		var $li = $('<li><a href="#interface-' + iface + '">' + iface + '</a></li>');
		$('#interfaces ul').append($li);
		var $ifconfig = $('<div class="interface"></div>');
		$('#interfaces').append($ifconfig);
		$ifconfig.attr('id', 'interface-' + iface);
		$ifconfig_table = $('<table border=0>');
		// Add global options above the individual ifaces
		add_option(config, data, $ifconfig_table, 'hwaddress', 'MAC Address', iface);
		add_option(config, data, $ifconfig_table, 'mtu', 'MTU', iface);

		if(iface.startsWith("wlan")){
			add_option(config, data, $ifconfig_table, 'wpa-ssid', 'WiFi SSID', iface);
			add_option(config, data, $ifconfig_table, 'wpa-psk', 'WiFi Password', iface);
		}
		// set each button to "disabled"
		$ifconfig_table.find('input').button('disable');
		$ifconfig.append($ifconfig_table);
		$ifconfig.append('<br />');

		$ifconfig_aliases = $('<div class="config-interface"></div>');
		$ifconfig.append($ifconfig_aliases);
		for (var alias in data[iface]) {
			//Exclude wierd secondary ip addresses
			if(alias.endsWith("-secondary")){
				continue;
			}
			console.log(alias);
			var inet = data[iface][alias].inet;
			if (!inet) {
				continue;
			}
			var inet_config;
			// Default to DHCP if we do not see our iface within the config
			if (config[alias] == undefined){
				inet_config = {"method": "dhcp"};

			}
			else{
		 		inet_config = config[alias].protocol.inet;
			}
			console.log(alias)
			var $alconfig = $('<div class="alias"></div>');
			$alconfig.attr('id', 'interface-' + iface + '-' + alias);
			// create the selection menu that will become our jqueryui combobox
			var $config_select = $('<select name="method"></select>');
			if (inet_config.method == "dhcp" || inet_config.method == "static") {
				$config_select.append('<option value="dhcp">DHCP</option>');
				$config_select.append('<option value="static">Static</option>');
			} else {
				$config_select.append('<option>'+inet_config.method+'</option>');
			}
			// set the value of our select menu and keep track of what it was originally
			$config_select.val(inet_config.method);
			$config_select.data('value_orig', inet_config.method);
			$alconfig.append($config_select);
			// create jquery combobox
			$config_select.selectmenu({
				width: 192,
				change: function (ev) { //event handler for changing values on select
					if ($(this).val() == 'static') {
						$(this).data('$inputs').filter('input[type=checkbox]').button('enable');
					} else {
						$(this).data('$inputs').filter('input[type=checkbox]').button('disable');
					}
					$(this).data('$inputs').filter('input[type=checkbox]').each(function (ev) {
						ui_changed($(this).data('$input'));
					});
					ui_changed($(this));
				}
			});
			var $alias_table = $('<table border="0"></table>');
			//add_option(config, data, $alias_table, 'hostname', 'Hostname', iface, alias);
			add_option(config, data, $alias_table, 'address', 'Address', iface, alias);
			add_option(config, data, $alias_table, 'netmask', 'Netmask', iface, alias);
			//add_option(config, data, $alias_table, 'pointopoint', 'Point to Point', iface, alias);
			add_option(config, data, $alias_table, 'gateway', 'Gateway', iface, alias);
			//add_option(config, data, $alias_table, 'metric', 'Metric', iface, alias);
			//add_option(config, data, $alias_table, 'nameserver', 'Nameserver', iface, alias);
			$alconfig.append($alias_table);
			$config_select.data('$inputs', $alias_table.find('input'));
			var $alias_widget = $('<h3>' + alias + '</h3>');
			$ifconfig_aliases.append($alias_widget);
			$ifconfig_aliases.append($alconfig);
			$alconfig.find('input, select').data('$alias', $alconfig)
					.data('$alias_widget', $alias_widget);
		}
		$ifconfig_aliases.accordion();
		$ifconfig.find('input, select').data('$iface', $ifconfig)
				.data('$iface_widget', $li);
/*
			$alconfig.html('\
	<div class="config-alias">\
		<span class="title">Configuration Method:</span>\
		<span class="form">\
			<select class="configure-method" name="method">\
				<option value="dhcp">DHCP</option>\
				<option value="static">Static</option>\
			</select>\
		</span>\
		<table border=0>\
		<!-- <tr><th>Scope:</th><td><select name="scope"><option>global</option><option>link</option><option>host</option></select></td></tr> -->\
		</table>\
	</div>');
	$alconfig.find(".configure-method").selectmenu({
		width:	128,
	});
*/
	}
	$("#interfaces").tabs();
	console.log($('#update').attr("disabled"))
	$('#update').button('enable');
}).fail(function (XHR, status, error) {
	alert("Failed to get configuration information!");
});
</script>
</body>
</html>
